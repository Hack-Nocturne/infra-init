name: Server Init & Provisioning

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable detailed & verbose output?'
        required: false
        default: false
        type: boolean

      target_env:
        type: choice
        description: "Select provisioning environment"
        options:
          - Dev
          - Prod
        default: Dev

      server_ipv4:
        description: "Target server IPv4 address"
        required: true
        default: "127.0.0.1"
        type: string

      server_username:
        description: "Target server SSH username"
        required: true
        default: "root"
        type: string

jobs:
  provision:
    name: Provision Remote Servers
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}
    
    defaults:
      run:
        shell: bash
        working-directory: ansible

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Mask IPv4
        run: |
          machine_ip=$(jq -r '.inputs.server_ipv4' ${GITHUB_EVENT_PATH})
          echo "::add-mask::${machine_ip}"

      - name: Setup SSH key
        id: setup_ssh_key
        env:
          DEPLOY_SSH_PUB_KEY: ${{ secrets.DEPLOY_SSH_PUB_KEY }}
          ADMIN_SSH_PUB_KEY: ${{ secrets.ADMIN_SSH_PUB_KEY }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_LOGIN_PRIV_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "$DEPLOY_SSH_PUB_KEY" > deploy.pub
          echo "$ADMIN_SSH_PUB_KEY" > admin.pub

      - name: Install Ansible & Passlib
        run: |
          pip install ansible passlib

      - name: Build inventory from dispatch inputs
        run: |
          mkdir -p inventory
          printf "all:\n  hosts:\n    server:\n      ansible_host: \"%s\"\n      ansible_user: \"%s\"\n" "${{ inputs.server_ipv4 }}" "${{ inputs.server_username }}" > inventory/hosts.yml

      - name: Test connectivity
        run: |
          echo "Testing connectivity to target hosts..."
          ansible all -m ping

      - name: Install ansible dependencies
        run: |
          echo "Installing Ansible dependencies..."
          ansible-galaxy collection install -r requirements.yml

      - name: Start Provisioning
        run: |
          echo "${{ secrets.CF_CERT }}" > cf_cert.pem
          echo "${{ secrets.CF_KEY }}" > cf_cert.key
          
          ansible-playbook site.yml \
            -e "obscured_dir=${{ secrets.OBSCURED_DIR }}" \
            -e "deploy_pwd=${{ secrets.DEPLOY_PWD }}" \
            -e "admin_pwd=${{ secrets.ADMIN_PWD }}" \
            -e "sec_ssh_port=${{ secrets.SEC_SSH_PORT }}" \
            ${{ inputs.verbose == 'true' && '-vvv' || '-v' }}

      - name: Test Connection Post-Provisioning
        run: |
          nc -zv -w 10 ${{ inputs.server_ipv4 }} ${{ secrets.SEC_SSH_PORT }}

      - name: Cleanup files
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ./cf_cert.pem
          rm -f ./cf_cert.key
          rm -f ./inventory/hosts.yml

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [provision]
    if: always()

    steps:
      - name: Notification
        run: |
          if [ "${{ needs.provision.result }}" == "success" ]; then
            echo "✅ VM provisioning completed successfully!"
          elif [ "${{ needs.provision.result }}" == "failure" ]; then
            echo "❌ VM provisioning failed!"
            exit 1
          elif [ "${{ needs.provision.result }}" == "skipped" ]; then
            echo "⏭️ VM provisioning was skipped due to validation failure!"
            exit 1
          else
            echo "⚠️ VM provisioning completed with unknown status: ${{ needs.provision.result }}"
          fi
