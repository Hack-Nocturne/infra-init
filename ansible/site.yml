- name: Provision Complete Stack
  hosts: all
  become: yes
  
  tasks:
    - import_tasks: tasks/01-warmup.yml
    - import_tasks: tasks/02-podman.yml
    - import_tasks: tasks/03-security.yml
    - import_tasks: tasks/04-nginx.yml

    - name: Reboot and Verify SSH on Custom port
      block:
        - name: Reboot the hosts
          reboot:
            reboot_timeout: 10
          ignore_errors: yes

        - name: Pause for reboot to take effect
          pause:
            seconds: 30

        - name: Change default Port and User to test
          set_fact:
            ansible_user: "{{ deploy_user }}"
            ansible_ssh_port: "{{ ssh_port }}"
            ansible_port: "{{ ssh_port }}"

        - name: Verify SSH connectivity on custom port
          wait_for:
            host: "{{ (ansible_ssh_host | default(ansible_host)) | default(inventory_hostname) }}"
            port: "{{ ssh_port }}"
            delay: 10
            timeout: 30
            state: started
